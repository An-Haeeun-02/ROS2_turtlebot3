# robot\_totalgrid\_pkg

## 개요

`robot_totalgrid_pkg`는 ROS2 기반의 경로 탐색 및 자동 주행 패키지로, 주어진 시작점과 목표점, 그리고 장애물 정보를 기반으로 그리드 상에서 최적 경로를 생성하고, 해당 경로에 따라 Turtlebot을 주행시키는 프로젝트입니다. 실시간 센서 데이터를 바탕으로 계단 감지, 장애물 회피, 직진 보정 등을 수행하며, 기존의 `robot_total_pkg`가 반사적 주행 기반이라면 본 패키지는 계획 기반 주행에 초점을 맞춥니다.

---

## 사용한 패키지

| 패키지명                | 용도                                       |
| ------------------- | ---------------------------------------- |
| `rclcpp`            | ROS2 노드 생성 및 통신                          |
| `std_msgs`          | 기본 메시지 타입 사용 (e.g., std\_msgs/String)    |
| `geometry_msgs`     | 로봇 제어용 Twist 메시지 및 거리 데이터 Vector3 메시지 사용 |
| `sensor_msgs`       | `/imu` 및 `/scan` 센서 메시지 수신               |
| `nav_msgs`          | 위치 추정을 위한 Odometry 메시지 사용                |
| `tf2_geometry_msgs` | IMU orientation 데이터에서 RPY 추출에 사용         |

---

## 설정 파일 설명

### CMakeLists.txt

* 빌드 도구로 `ament_cmake`를 사용합니다.
* 의존성 패키지들을 `find_package`로 탐색합니다.
* `scan_node`, `drive_node` 실행 파일을 각각 등록하여 설치 대상에 포함시킵니다.
* 센서, odom, tf2 등의 의존 패키지를 추가합니다.

### package.xml

* ROS2 패키지 메타데이터를 정의합니다.
* 실행 시 필요한 메시지 패키지 및 빌드 툴 의존성을 명시합니다.
* 테스트와 코드 린트를 위한 설정 포함.
* `rclcpp`, `std_msgs`, `geometry_msgs`, `sensor_msgs`, `nav_msgs`, `tf2_geometry_msgs` 등 종속성을 선언합니다.

---

## 실행 노드 구성

### 1. `grid_node`

* **기능**: 경로 탐색, 장애물 등록, 회전 포인트 설정 및 명령 전달.
* **주요 역할**:

  * 사용자 입력을 통해 시작점, 도착점, 장애물 좌표를 수신
  * 경로 탐색 알고리즘 (예: A\*) 실행
  * 회전 포인트를 설정하여 주행 노드에 전달
  * `path_pub` 토픽에 경로 메시지 발행

### 2. `drive_node`

* **기능**: 로봇 실시간 제어, IMU 기반 직진 보정, 장애물 및 계단 감지
* **주요 역할**:

  * `aeeun`, `hyewon`, `dongwan`, `haeeun` 토픽으로부터 거리 벡터 수신
  * `/imu`, `/odom` 데이터를 기반으로 방향 보정 및 위치 추정
  * 센서 기반 장애물/계단 감지 및 회피
  * `cmd_vel`로 속도 명령 발행
  * 회전 포인트에서 자율 회전 수행

---

## 주요 기능 요약

| 기능          | 설명                                   |
| ----------- | ------------------------------------ |
| 경로 탐색       | 시작점-도착점, 장애물 좌표 입력 기반 경로 생성          |
| 회전 포인트 설정   | 경로의 굴절 지점을 별도 포인트로 설정하여 주행 로직과 연계    |
| 직진 보정       | IMU 데이터를 기반으로 현재 각도와 초기 방향의 차이를 보정   |
| 장애물 감지 및 회피 | 거리 센서 데이터를 기반으로 장애물 탐지 및 우/좌회전 경로 실행 |
| 계단 감지       | 전방 센서 데이터가 특정 임계값을 초과하면 로봇 정지        |
| 위치 인식       | Odometry 데이터를 기반으로 로봇의 현재 좌표 추정 가능   |

---

## 토픽 구조

| 토픽 이름     | 메시지 타입                      | 설명                     |
| --------- | --------------------------- | ---------------------- |
| `cmd_vel` | `geometry_msgs/msg/Twist`   | 로봇의 속도 명령 전송           |
| `aeeun`   | `geometry_msgs/msg/Vector3` | 정면(0, 90, 270도) 거리 데이터 |
| `hyewon`  | `geometry_msgs/msg/Vector3` | 우측 (30, 60도) 거리 데이터    |
| `dongwan` | `geometry_msgs/msg/Vector3` | 좌측 (300, 330도) 거리 데이터  |
| `haeeun`  | `geometry_msgs/msg/Vector3` | 전방 하단 거리 (계단 탐지용)      |
| `/imu`    | `sensor_msgs/msg/Imu`       | 방향 보정용 IMU 센서 데이터      |
| `/odom`   | `nav_msgs/msg/Odometry`     | 주행 보조를 위한 위치 데이터       |

---

## 작동 방식 설명

1. 사용자는 `grid_node`를 통해 시작점, 도착점, 장애물 위치를 입력하려 맵을 설정합니다.
2. A\* 알고리즘을 통해 최적 경로가 생성되고, 회전 지점은 별도로 저장됩니다.
3. `drive_node`는 경로에 따라 로봇을 직진시키며, IMU 데이터를 바탕으로 진행 방향을 지속적으로 보정합니다.
4. 거리 센서(`aeeun`, `hyewon`, `dongwan`)와 하단 센서(`haeeun`)를 이용해 장애물이나 계단을 실시간 감지합니다.
5. **장애물이 감지되면**, 로봇은 전진을 멈추고, 장애물의 위치를 좌표화화 하여 미리 입력한 장애물인지, 새로운 장애물인지 검사합니다.
6. 만약 새로운 장애물이라면 로봇은 맵에 새로운 장애물을 입력하고, 기존 장애물이라면, 알고리즘에 따라 장애물을 피해서 도착점으로 이동합니다.
7. **계단이 감지되면**, 로봇은 즉시 정지하고 더 이상 주행하지 않습니다.
8. 주행 도중 IMU 센서를 통해 직진 각도를 보정하고, `/odom`을 통해 자신의 현재 위치를 좌표 값으로 인식하며 주행의 정확도를 높입니다.
9. 센서값이 사전에 설정한 임계값보다 지속적으로 낮게 측정되면 주행을 종료하고 ROS2 노드를 종료합니다.

---

## 설치 및 빌드

```bash
cd ~/ros2_ws/src
git clone <repo_url> robot_totalgrid_pkg
cd ~/ros2_ws
colcon build --packages-select robot_totalgrid_pkg
source install/setup.bash
```

## 실행 방법

### 1. LIDAR 거리 측정 노드 실행

```bash
ros2 run robot_totalgrid_pkg scan_node
```

### 2. 경로 생성 및 주행 노드 실행

```bash
ros2 run robot_totalgrid_pkg drive_node
```

---

## 관련 패키지 비교

| 패키지 이름                | 주행 방식     | 센서 사용       | 경로 계획 | IMU/odom 사용 |
| --------------------- | --------- | ----------- | ----- | ----------- |
| `robot_total_pkg`     | 실시간 회피 기반 | LIDAR + IMU | 없음    | 있음          |
| `robot_totalgrid_pkg` | 경로 계획 기반  | LIDAR + IMU | 있음    | 있음          |

